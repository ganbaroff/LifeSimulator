# üöÄ CI/CD Pipeline for Life Simulator Azerbaijan
# –°–æ–∑–¥–∞–Ω–æ: DevOps (Agile Team)
# –í–µ—Ä—Å–∏—è: 1.0.0

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  EXPO_CLI_VERSION: '6.0.8'

jobs:
  # üîç Code Quality & Testing
  test:
    name: Test & Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript check
      run: npx tsc --noEmit
      
    - name: ESLint check
      run: npx eslint src --ext .ts,.tsx --max-warnings=0
      
    - name: Prettier check
      run: npx prettier --check "src/**/*.{ts,tsx,js,jsx}"
      
    - name: Unit tests
      run: npm test -- --coverage --watchAll=false
      
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info

  # üèóÔ∏è Build & Package
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Expo CLI
      run: npm install -g @expo/cli@${{ env.EXPO_CLI_VERSION }}
      
    - name: Build for web
      run: npx expo build:web
      
    - name: Build Android APK
      run: npx expo build:android --type apk --release-channel production
      
    - name: Build iOS IPA
      run: npx expo build:ios --type archive --release-channel production
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          dist/
          *.apk
          *.ipa

  # üîí Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: Audit npm dependencies
      run: npm audit --audit-level moderate

  # üìä Performance & Bundle Analysis
  analyze:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Bundle size analysis
      run: |
        npx expo build:web
        npx bundlesize
        
    - name: Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        lhci autorun
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # üöÄ Deployment
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build, security, analyze]
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: https://life-simulator-azerbaijan.vercel.app
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        
    - name: Deploy to Expo
      run: |
        npx expo build:web --output-dir dist
        npx expo publish --release-channel production
        
    - name: Notify deployment
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # üì± Mobile Distribution
  mobile-distribute:
    name: Distribute Mobile Apps
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
        
    - name: Distribute to App Store
      uses: apple-actions/upload-testflight-build@v1
      with:
        app-path: '*.ipa'
        apple-id: ${{ secrets.APPLE_ID }}
        app-specific-password: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        
    - name: Distribute to Google Play
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.lifesimulator.azerbaijan
        releaseFiles: '*.apk'
        track: production
        status: completed

  # üìä Monitoring & Health Check
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for deployment
      run: sleep 60
      
    - name: Health check
      run: |
        curl -f https://life-simulator-azerbaijan.vercel.app || exit 1
        
    - name: Performance monitoring
      run: |
        curl -o /dev/null -s -w "%{http_code}\n" https://life-simulator-azerbaijan.vercel.app
        
    - name: Update monitoring dashboard
      run: |
        curl -X POST "${{ secrets.MONITORING_WEBHOOK }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "healthy", "version": "${{ github.sha }}"}'
